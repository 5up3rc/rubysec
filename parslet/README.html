<!DOCTYPE HTML>
<html lang="en-US" manifest="../manifest.appcache">
    <head prefix="og: http://ogp.me/ns# book: http://ogp.me/ns/book#">
        
        <meta charset="UTF-8">
        <title>Parslet | RubySec Field Guide</title>

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="robots" content="index, follow">
        <meta name="author" content="trailofbits">
        <meta name="description" content="In the last year, many new vulnerabilities and vulnerability classes have been discovered in Ruby applications. These vulnerabilities make use of features specific to the Ruby language and common idioms present in large Ruby projects, such as serialization and deserialization of data in the YAML format. As these vulnerability classes were initially discovered in popular and well-studied open source software, itâ€™s extremely likely that they occur in applications throughout the Ruby ecosystem. These applications frequently represent lucrative targets for attackers, and with the appearance of new and easily exploitable bug classes, the potential for targeted and mass exploitation of Ruby programs has been demonstrated to the world. In this training, we aim to bridge a knowledge and skills gap by bringing information about these new vulnerability classes to software developers.">
        <meta name="keywords" content="gitbook,github" >
        <meta name="generator" content="www.gitbook.io">

        
        <link rel="next" href="../parslet/json1.html" />
        
        
        <link rel="prev" href="../yaml/yaml4.html" />
        

        <meta property="og:title" content="Parslet | RubySec Field Guide">
        <meta property="og:site_name" content="RubySec Field Guide">
        <meta property="og:type" content="book">
        <meta property="og:locale" content="en_US">

        <meta property="book:author" content="https://github.com/trailofbits">
        <meta property="book:tag" content="GitBook">

        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">

        <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">
        
    </head>
    <body>
        

        <link rel="stylesheet" href="../gitbook/style.css">
        


        
    <div class="book" data-github="trailofbits/rubysec" data-level="2" data-basepath=".." data-revision="1400706499331">
    <div class="book-header">
    <!-- Actions Left -->
    
    <a href="https://github.com/trailofbits/rubysec" target="_blank" class="btn pull-left home-bookmark" aria-label="GitHub home"><i class="fa fa-bookmark-o"></i></a>
    
    <a href="#" class="btn pull-left toggle-summary" aria-label="Toggle summary"><i class="fa fa-align-justify"></i></a>
    <a href="#" class="btn pull-left toggle-search" aria-label="Toggle search"><i class="fa fa-search"></i></a>
    <span id="font-settings-wrapper">
        <a href="#" class="btn pull-left toggle-font-settings" aria-label="Toggle font settings"><i class="fa fa-font"></i>
        </a>
        <div class="dropdown-menu font-settings">
    <div class="dropdown-caret">
        <span class="caret-outer"></span>
        <span class="caret-inner"></span>
    </div>

    <div class="btn-group btn-block">
        <button id="reduce-font-size" class="btn btn-default">A</button>
        <button id="enlarge-font-size" class="btn btn-default">A</button>
    </div>

    <ul class="list-group font-family-list">
        <li class="list-group-item" data-font="0">Serif</li>
        <li class="list-group-item" data-font="1">Sans</li>
    </ul>

    <div class="btn-group btn-group-xs btn-block color-theme-list">
        <button type="button" class="btn btn-default" id="color-theme-preview-0" data-theme="0">White</button>
        <button type="button" class="btn btn-default" id="color-theme-preview-1" data-theme="1">Sepia</button>
        <button type="button" class="btn btn-default" id="color-theme-preview-2" data-theme="2">Night</button>
    </div>
</div>

    </span>

    <!-- Actions Right -->
    
    <a href="#" target="_blank" class="btn pull-right google-plus-sharing-link sharing-link" data-sharing="google-plus" aria-label="Share on Google Plus"><i class="fa fa-google-plus"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right facebook-sharing-link sharing-link" data-sharing="facebook" aria-label="Share on Facebook"><i class="fa fa-facebook"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right twitter-sharing-link sharing-link" data-sharing="twitter" aria-label="Share on Twitter"><i class="fa fa-twitter"></i></a>
    

    
    <a href="https://github.com/trailofbits/rubysec/stargazers" target="_blank" class="btn pull-right count-star hidden-xs"><i class="fa fa-star-o"></i> Star (<span>-</span>)</a>
    <a href="https://github.com/trailofbits/rubysec/watchers" target="_blank" class="btn pull-right count-watch hidden-xs"><i class="fa fa-eye"></i> Watch (<span>-</span>)</a>
    

    <!-- Title -->
    <h1>
        <i class="fa fa-spinner fa-spin"></i>
        <a href="../" >RubySec Field Guide</a>
    </h1>
</div>

    <div class="book-summary">
    <div class="book-search">
        <input type="text" placeholder="Search" class="form-control" />
    </div>
    <ul class="summary">
        
        <li>
            <a href="https://github.com/trailofbits" target="blank" class="author-link">About the author</a>
        </li>
        

        
        <li>
            <a href="https://github.com/trailofbits/rubysec/issues" target="blank"class="issues-link">Questions and Issues</a>
        </li>
        

        
        <li>
            <a href="https://github.com/trailofbits/rubysec/edit/master/parslet/README.md" target="blank" class="contribute-link">Edit and Contribute</a>
        </li>
        

        

        <li data-level="0" data-path="index.html">
            <a href="../"><i class="fa fa-check"></i> Introduction</a>
        </li>
        
            <li class="chapter " data-level="1" data-path="yaml/README.html">
                
                <a href="../yaml/README.html">
                    <i class="fa fa-check"></i> <b>1.</b> YAML
                </a>
                
                
                <ul class="articles">
                    
                        <li  data-level="1.1" data-path="yaml/yaml1.html">
                            
                            <a href="../yaml/yaml1.html">
                                <i class="fa fa-check"></i> <b>1.1.</b> YAML 1
                            </a>
                            
                        </li>
                    
                        <li  data-level="1.2" data-path="yaml/yaml2.html">
                            
                            <a href="../yaml/yaml2.html">
                                <i class="fa fa-check"></i> <b>1.2.</b> YAML 2
                            </a>
                            
                        </li>
                    
                        <li  data-level="1.3" data-path="yaml/yaml3.html">
                            
                            <a href="../yaml/yaml3.html">
                                <i class="fa fa-check"></i> <b>1.3.</b> YAML 3
                            </a>
                            
                        </li>
                    
                        <li  data-level="1.4" data-path="yaml/yaml4.html">
                            
                            <a href="../yaml/yaml4.html">
                                <i class="fa fa-check"></i> <b>1.4.</b> YAML 4
                            </a>
                            
                        </li>
                    
                </ul>
                
            </li>
        
            <li class="chapter " data-level="2" data-path="parslet/README.html">
                
                <a href="../parslet/README.html">
                    <i class="fa fa-check"></i> <b>2.</b> Parslet
                </a>
                
                
                <ul class="articles">
                    
                        <li  data-level="2.1" data-path="parslet/json1.html">
                            
                            <a href="../parslet/json1.html">
                                <i class="fa fa-check"></i> <b>2.1.</b> JSON 1
                            </a>
                            
                        </li>
                    
                        <li  data-level="2.2" data-path="parslet/json2.html">
                            
                            <a href="../parslet/json2.html">
                                <i class="fa fa-check"></i> <b>2.2.</b> JSON 2
                            </a>
                            
                        </li>
                    
                </ul>
                
            </li>
        
            <li class="chapter " data-level="3" data-path="mutant/README.html">
                
                <a href="../mutant/README.html">
                    <i class="fa fa-check"></i> <b>3.</b> Mutant
                </a>
                
                
                <ul class="articles">
                    
                        <li  data-level="3.1" data-path="mutant/mutant1.html">
                            
                            <a href="../mutant/mutant1.html">
                                <i class="fa fa-check"></i> <b>3.1.</b> Mutant 1
                            </a>
                            
                        </li>
                    
                </ul>
                
            </li>
        
            <li class="chapter " data-level="4" data-path="ronin/README.html">
                
                <a href="../ronin/README.html">
                    <i class="fa fa-check"></i> <b>4.</b> Ronin
                </a>
                
                
                <ul class="articles">
                    
                        <li  data-level="4.1" data-path="ronin/exploit1.html">
                            
                            <a href="../ronin/exploit1.html">
                                <i class="fa fa-check"></i> <b>4.1.</b> Exploit 1
                            </a>
                            
                        </li>
                    
                </ul>
                
            </li>
        
            <li class="chapter " data-level="5" data-path="contributors/README.html">
                
                <a href="../contributors/README.html">
                    <i class="fa fa-check"></i> <b>5.</b> Contributors
                </a>
                
                
            </li>
        

        
        <li class="divider"></li>
        <li>
            <a href="http://www.gitbook.io/" target="blank" class="gitbook-link">Generated using GitBook</a>
        </li>
        
    </ul>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="page-wrapper" tabindex="-1">
                <div class="book-progress">
    <div class="bar">
        <div class="inner" style="width: 46.15384615384615%;min-width: 38.46153846153846%;"></div>
    </div>
    <div class="chapters">
    
        <a href="../index.html" title="Introduction" class="chapter done new-chapter" data-progress="0" style="left: 0%;"></a>
    
        <a href="../yaml/README.html" title="YAML" class="chapter done new-chapter" data-progress="1" style="left: 7.6923076923076925%;"></a>
    
        <a href="../yaml/yaml1.html" title="YAML 1" class="chapter done " data-progress="1.1" style="left: 15.384615384615385%;"></a>
    
        <a href="../yaml/yaml2.html" title="YAML 2" class="chapter done " data-progress="1.2" style="left: 23.076923076923077%;"></a>
    
        <a href="../yaml/yaml3.html" title="YAML 3" class="chapter done " data-progress="1.3" style="left: 30.76923076923077%;"></a>
    
        <a href="../yaml/yaml4.html" title="YAML 4" class="chapter done " data-progress="1.4" style="left: 38.46153846153846%;"></a>
    
        <a href="../parslet/README.html" title="Parslet" class="chapter done new-chapter" data-progress="2" style="left: 46.15384615384615%;"></a>
    
        <a href="../parslet/json1.html" title="JSON 1" class="chapter  " data-progress="2.1" style="left: 53.84615384615385%;"></a>
    
        <a href="../parslet/json2.html" title="JSON 2" class="chapter  " data-progress="2.2" style="left: 61.53846153846154%;"></a>
    
        <a href="../mutant/README.html" title="Mutant" class="chapter  new-chapter" data-progress="3" style="left: 69.23076923076923%;"></a>
    
        <a href="../mutant/mutant1.html" title="Mutant 1" class="chapter  " data-progress="3.1" style="left: 76.92307692307692%;"></a>
    
        <a href="../ronin/README.html" title="Ronin" class="chapter  new-chapter" data-progress="4" style="left: 84.61538461538461%;"></a>
    
        <a href="../ronin/exploit1.html" title="Exploit 1" class="chapter  " data-progress="4.1" style="left: 92.3076923076923%;"></a>
    
        <a href="../contributors/README.html" title="Contributors" class="chapter  new-chapter" data-progress="5" style="left: 100%;"></a>
    
    </div>
</div>

                <div class="page-inner">
                
                    <section class="normal" id="section-gitbook_5">
                    
                        <h1 id="parser">Parser</h1>
<p>Parsing is a classic (Hard&trade;) computer science problem and a common source of security vulnerabilities.  Specifically, YAML recent had a big problem with this as described in <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2013-0156" target="_blank">CVE-2013-0156</a>. Thus a good question to review is how do parsers work in the first place?  Most parsers take on something similar to the below set of logical steps:</p>
<ol>
<li>Accept a set of rules (and some accompanying actions) and a sequence of tokens.  This step is commonly referred to as the <a href="http://en.wikipedia.org/wiki/Lexical_analysis" target="_blank">Lexical Analysis</a>.</li>
<li>Attempt to match a sequence of tokens against a supplied <a href="http://en.wikipedia.org/wiki/Formal_grammar" target="_blank">grammar</a>. Most programming languages can be specified as <a href="http://en.wikipedia.org/wiki/Context-free_grammar" target="_blank">Context-Free Grammars</a>. Nearly all serialization formats are <a href="http://en.wikipedia.org/wiki/Regular_grammar" target="_blank">Regular</a> or Context-Free Grammars.</li>
<li>When the parser encounters a sequence of tokens matching a rule specified in the grammar, it will perform the affiliated action. Generally the goal is to build a tree.</li>
</ol>
<p>If the above series of steps sounds familiar, it&#39;s because this is the common process used for compiling a program.  The goal here is typically to build an <a href="http://en.wikipedia.org/wiki/Abstract_syntax_tree" target="_blank">abstract syntax-tree</a>. If none of this material seems to be making any sense, or you have not had an introductory compilers course, take a look at the &#39;Additional Resources&#39; section detailed below for some educational material.</p>
<h2 id="parslet">Parslet</h2>
<p><a href="http://kschiess.github.io/parslet/" target="_blank">Parslet</a> is a pure Ruby library (no compiling!) for constructing lexers/parsers with a clean Ruby DSL. It uses Parsing Expression Grammar (or PEG) which is essentially a Context-Free Grammar with no ambiguity, to perform greedy parsing. Most parsers built on Parslet are built in two stages. First, the input is <em>parsed</em> into an intermediate tree (level 1 exercise below) and, second, the input is <em>transformed</em> from the intermediary tree into a desired representation (level 2 exercise below).</p>
<h2 id="parslet-pointers">Parslet Pointers</h2>
<p>More information is detailed in the <a href="http://kschiess.github.io/parslet/get-started.html" target="_blank">Parslet Getting Started doc</a>.</p>
<h3 id="parslet-parser">Parslet::Parser</h3>
<ul>
<li>Specify rules<ul>
<li><code>rule(name) { definition }</code></li>
</ul>
</li>
<li>Define the root rule:<ul>
<li><code>root :name</code></li>
</ul>
</li>
<li><code>str(...)</code> matches a literal string</li>
<li><code>repeat</code> is equivalent of <code>regex*</code></li>
<li><code>repeat(1)</code> is equivalent to <code>regex+</code></li>
<li><code>repeat(1,5)</code> is equivalent to <code>regex{1,2}</code></li>
<li><code>match(...)</code> matches data against the specified regular expression</li>
<li><code>match[&#39;a-z&#39;]</code> is shorthand for <code>match(&#39;[a-z&#39;])</code></li>
<li><code>|</code> denotes union and <code>&gt;&gt;</code> denotes concatenation</li>
</ul>
<h3 id="parslet-transform">Parslet::Transform</h3>
<ul>
<li>Specify rules (different meaning here)<ul>
<li><code>rule(pattern) { action }</code></li>
</ul>
</li>
<li>Parslet automatically walks the intermediary tree for you and performs
<code>action</code> whenever it encounters <code>pattern</code></li>
<li><code>simple(:name)</code> matches a single String value.</li>
<li><code>sequence(:name)</code> matches an Array of String values.</li>
<li><code>subtree(:name)</code> matches a Hash within the Parslet tree.</li>
</ul>
<h2 id="workshop-json-parsing">Workshop: JSON Parsing</h2>
<p>In the following workshops we will have you walkthrough building a JSON parser using Parslet. The first level will have you construct the lexical analysis rules for carving the input into tokens. The second level will be concerned with transforming these lexical tokens into Ruby actions. We have provided you with boilerplate code as linked below in the workshop files.</p>
<p>For each of these exercises we have provided Rspec tests for you to check that your implementations are correct, when all of the Rspec tests pass, turn green, then you know you&#39;ve completed the level! If you are unfamiliar with take a look at
this <a href="http://blog.davidchelimsky.net/blog/2007/05/14/an-introduction-to-rspec-part-i/" target="_blank">Rspec primer</a>.</p>
<p><em>While writing out your code, take exceptional care not to introduce vulnerabilities in the transformation process!</em></p>
<h2 id="additional-resources">Additional Resources</h2>
<ul>
<li><a href="http://en.wikibooks.org/wiki/Compiler_Construction/Introduction" target="_blank">WikiBooks Compiler Construction/Introduction</a></li>
<li><a href="http://kschiess.github.com/parslet/" target="_blank">Parslet</a></li>
<li><a href="http://en.wikipedia.org/wiki/Parsing_expression_grammar" target="_blank">Parsing Expression Grammar, or PEG</a></li>
<li><a href="http://www.ietf.org/rfc/rfc4627.txt" target="_blank">RFC 4627 - JSON Parsing</a></li>
<li><a href="http://www.json.org/" target="_blank">JSON</a></li>
</ul>

                    
                    </section>
                
                </div>
            </div>
        </div>

        
        <a href="../yaml/yaml4.html" class="navigation navigation-prev " aria-label="Previous page: YAML 4"><i class="fa fa-angle-left"></i></a>
        
        
        <a href="../parslet/json1.html" class="navigation navigation-next " aria-label="Next page: JSON 1"><i class="fa fa-angle-right"></i></a>
        
    </div>
</div>

        

        <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.1.3/ace.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.1.3/mode-javascript.js"></script>
        <script src="../gitbook/jsrepl/jsrepl.js" id="jsrepl-script"></script>
        <script src="../gitbook/app.js"></script>
        

    
    <script src="../gitbook/plugins/gitbook-plugin-mixpanel/plugin.js"></script>
    

    
    <script src="http://cdn.mathjax.org/mathjax/2.0-latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-mathjax/plugin.js"></script>
    

<script>
require(["gitbook"], function(gitbook) {
    var config = {};
    gitbook.start(config);
});
</script>

    </body>
</html>

<!DOCTYPE HTML>
<html lang="en-US" manifest="../manifest.appcache">
    
    <head>
        
        <meta charset="UTF-8">
        <title>YAML | RubySec Field Guide</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 0.5.6">
        <meta name="HandheldFriendly" content="true"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">
        
    
    
    <meta name="author" content="trailofbits">
    
    
    <link rel="next" href="../yaml/yaml1.html" />
    
    
    <link rel="prev" href="../index.html" />
    

        
    </head>
    <body>
        
        
<link rel="stylesheet" href="../gitbook/style.css">


        
    <div class="book" data-github="trailofbits/rubysec" data-level="1" data-basepath=".." data-revision="1404262423517">
    <div class="book-header">
    <!-- Actions Left -->
    <a href="#" class="btn pull-left toggle-summary" aria-label="Toggle summary"><i class="fa fa-align-justify"></i></a>
    
    <a href="https://github.com/trailofbits/rubysec" target="_blank" class="btn pull-left home-bookmark" aria-label="GitHub home"><i class="fa fa-bookmark-o"></i></a>
    
    <a href="#" class="btn pull-left toggle-search" aria-label="Toggle search"><i class="fa fa-search"></i></a>
    <span id="font-settings-wrapper">
        <a href="#" class="btn pull-left toggle-font-settings" aria-label="Toggle font settings"><i class="fa fa-font"></i>
        </a>
        <div class="dropdown-menu font-settings">
    <div class="dropdown-caret">
        <span class="caret-outer"></span>
        <span class="caret-inner"></span>
    </div>

    <div class="btn-group btn-block">
        <button id="reduce-font-size" class="btn btn-default">A</button>
        <button id="enlarge-font-size" class="btn btn-default">A</button>
    </div>

    <ul class="list-group font-family-list">
        <li class="list-group-item" data-font="0">Serif</li>
        <li class="list-group-item" data-font="1">Sans</li>
    </ul>

    <div class="btn-group btn-group-xs btn-block color-theme-list">
        <button type="button" class="btn btn-default" id="color-theme-preview-0" data-theme="0">White</button>
        <button type="button" class="btn btn-default" id="color-theme-preview-1" data-theme="1">Sepia</button>
        <button type="button" class="btn btn-default" id="color-theme-preview-2" data-theme="2">Night</button>
    </div>
</div>

    </span>

    <!-- Actions Right -->
    
    <a href="#" target="_blank" class="btn pull-right google-plus-sharing-link sharing-link" data-sharing="google-plus" aria-label="Share on Google Plus"><i class="fa fa-google-plus"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right facebook-sharing-link sharing-link" data-sharing="facebook" aria-label="Share on Facebook"><i class="fa fa-facebook"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right twitter-sharing-link sharing-link" data-sharing="twitter" aria-label="Share on Twitter"><i class="fa fa-twitter"></i></a>
    

    
    <a href="https://github.com/trailofbits/rubysec/stargazers" target="_blank" class="btn pull-right count-star hidden-xs"><i class="fa fa-star-o"></i> Star (<span>-</span>)</a>
    <a href="https://github.com/trailofbits/rubysec/watchers" target="_blank" class="btn pull-right count-watch hidden-xs"><i class="fa fa-eye"></i> Watch (<span>-</span>)</a>
    

    <!-- Title -->
    <h1>
        <i class="fa fa-spinner fa-spin"></i>
        <a href="../" >RubySec Field Guide</a>
    </h1>
</div>

    

<div class="book-summary">
    <div class="book-search">
        <input type="text" placeholder="Search" class="form-control" />
    </div>
    <ul class="summary">
        
        
        
        <li>
            <a href="https://github.com/trailofbits" target="blank" class="author-link">About the author</a>
        </li>
        

        
        
        <li>
            <a href="https://github.com/trailofbits/rubysec/issues" target="blank"class="issues-link">Questions and Issues</a>
        </li>
        

        
        
        <li>
            <a href="https://github.com/trailofbits/rubysec/edit/master/yaml/README.md" target="blank" class="contribute-link">Edit and Contribute</a>
        </li>
        

        
        <li class="divider"></li>
        

        
    
        
        <li class="chapter " data-level="0" data-path="index.html">
            
                
                    <a href="../index.html">
                        <i class="fa fa-check"></i>
                        
                         Introduction
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1" data-path="yaml/README.html">
            
                
                    <a href="../yaml/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.</b>
                        
                         YAML
                    </a>
                
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="1.1" data-path="yaml/yaml1.html">
            
                
                    <a href="../yaml/yaml1.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.1.</b>
                        
                         YAML 1
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1.2" data-path="yaml/yaml2.html">
            
                
                    <a href="../yaml/yaml2.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.2.</b>
                        
                         YAML 2
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1.3" data-path="yaml/yaml3.html">
            
                
                    <a href="../yaml/yaml3.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.3.</b>
                        
                         YAML 3
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1.4" data-path="yaml/yaml4.html">
            
                
                    <a href="../yaml/yaml4.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.4.</b>
                        
                         YAML 4
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="2" data-path="parslet/README.html">
            
                
                    <a href="../parslet/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.</b>
                        
                         Parslet
                    </a>
                
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="2.1" data-path="parslet/json1.html">
            
                
                    <a href="../parslet/json1.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.1.</b>
                        
                         JSON 1
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="2.2" data-path="parslet/json2.html">
            
                
                    <a href="../parslet/json2.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.2.</b>
                        
                         JSON 2
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="3" data-path="mutant/README.html">
            
                
                    <a href="../mutant/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.</b>
                        
                         Mutant
                    </a>
                
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="3.1" data-path="mutant/mutant1.html">
            
                
                    <a href="../mutant/mutant1.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.1.</b>
                        
                         Mutant 1
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="4" data-path="ronin/README.html">
            
                
                    <a href="../ronin/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>4.</b>
                        
                         Ronin
                    </a>
                
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="4.1" data-path="ronin/exploit1.html">
            
                
                    <a href="../ronin/exploit1.html">
                        <i class="fa fa-check"></i>
                        
                            <b>4.1.</b>
                        
                         Exploit 1
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="5" data-path="contributors.html">
            
                
                    <a href="../contributors.html">
                        <i class="fa fa-check"></i>
                        
                            <b>5.</b>
                        
                         Contributors
                    </a>
                
            
            
        </li>
    


        
        <li class="divider"></li>
        <li>
            <a href="http://www.gitbook.io/" target="blank" class="gitbook-link">Generated using GitBook</a>
        </li>
        
    </ul>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="page-wrapper" tabindex="-1">
                <div class="book-progress">
    <div class="bar">
        <div class="inner" style="width: 7.6923076923076925%;min-width: 0%;"></div>
    </div>
    <div class="chapters">
    
        <a href="../index.html" title="Introduction" class="chapter done new-chapter" data-progress="0" style="left: 0%;"></a>
    
        <a href="../yaml/README.html" title="YAML" class="chapter done new-chapter" data-progress="1" style="left: 7.6923076923076925%;"></a>
    
        <a href="../yaml/yaml1.html" title="YAML 1" class="chapter  " data-progress="1.1" style="left: 15.384615384615385%;"></a>
    
        <a href="../yaml/yaml2.html" title="YAML 2" class="chapter  " data-progress="1.2" style="left: 23.076923076923077%;"></a>
    
        <a href="../yaml/yaml3.html" title="YAML 3" class="chapter  " data-progress="1.3" style="left: 30.76923076923077%;"></a>
    
        <a href="../yaml/yaml4.html" title="YAML 4" class="chapter  " data-progress="1.4" style="left: 38.46153846153846%;"></a>
    
        <a href="../parslet/README.html" title="Parslet" class="chapter  new-chapter" data-progress="2" style="left: 46.15384615384615%;"></a>
    
        <a href="../parslet/json1.html" title="JSON 1" class="chapter  " data-progress="2.1" style="left: 53.84615384615385%;"></a>
    
        <a href="../parslet/json2.html" title="JSON 2" class="chapter  " data-progress="2.2" style="left: 61.53846153846154%;"></a>
    
        <a href="../mutant/README.html" title="Mutant" class="chapter  new-chapter" data-progress="3" style="left: 69.23076923076923%;"></a>
    
        <a href="../mutant/mutant1.html" title="Mutant 1" class="chapter  " data-progress="3.1" style="left: 76.92307692307692%;"></a>
    
        <a href="../ronin/README.html" title="Ronin" class="chapter  new-chapter" data-progress="4" style="left: 84.61538461538461%;"></a>
    
        <a href="../ronin/exploit1.html" title="Exploit 1" class="chapter  " data-progress="4.1" style="left: 92.3076923076923%;"></a>
    
        <a href="../contributors.html" title="Contributors" class="chapter  new-chapter" data-progress="5" style="left: 100%;"></a>
    
    </div>
</div>

                <div class="page-inner">
                
                    <section class="normal" id="section-gitbook_10">
                    
                        <h1 id="yaml">YAML</h1>
<p><a href="http://www.yaml.org" target="_blank">YAML</a>, the once de facto serialization format for Ruby on Rails, now disabled by default due to <a href="[https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2013-0156">CVE-2013-0156</a>, is a superset of JSON.  YAML Supports all of the same regular types that JSON supports, however it also supports the serialization of arbitrary Ruby objects.  This can lead to vulnerabilities when combined with some common Ruby on Rails idions.</p>
<p>Most, if not all, YAML vulnerabiliies arise from the use of some form of Ruby&#39;s <code>eval</code> function.  As Ruby&#39;s Class namespace is global, if there exists some class loaded at the time the YAML parser is running, containing a call to eval, the YAML parser will be able to see and further access, this <code>eval</code> usage.  An attacker can then leverage this vulnerability to coerce the parser into making <code>eval</code> calls with arbitrary commands.  If this sounds like a bad desing to you, it&#39;s because it is, and it&#39;s something that every Ruby programmer needs to be <em>very</em> aware of.</p>
<p>More specifically, to leverage this vulnerability, an attacker need only instantiate an instance of any class which directly <code>eval</code>s on input.  Currently proof of concepts exist throughout the internet for how this is done, but there is relatively little exploit code to be found.  A second methodology is an attacker can instanciate a class which <code>instance_eval</code>s input to dynamically define a method, which is a common idiom for Ruby on Rails, and then need only escape out of the method definition.  It is further worth noting that if the dynamic method declaration takes the method name from the input then we can simply inject into the method name, as opposed to the body.</p>
<h2 id="pointers">Pointers</h2>
<ul>
<li><p>Find a class which uses some form of <code>eval</code> with one of it&#39;s fields. Note that you can set all of these fields in YAML, recall the global scope of Ruby classes, so you can pass input to the <code>eval</code> call.</p>
</li>
<li><p>Most of the time the <code>eval</code> call is used to dynamically define methods. While there are safer ways to do this, <code>eval</code> was used because it&#39;s supposedly faster in Ruby 1.8.  To do this you must craft the input to escape out of the method definition,run the desired code, and then start a new method definition so that the input parses correctly.</p>
</li>
<li><p>Sometimes it&#39;s possible to inject code inside the name of a method as opposed to it&#39;s body</p>
</li>
<li><p>If some form of string escaping technique is uesd, try crafting an instance of <code>Struct</code> which overrides whatever method name is performing the the escape.</p>
</li>
<li><p>Often times more complex forms of injection will be necessary.  Don&#39;t be afraid to get creative!</p>
</li>
</ul>
<h2 id="mitigations">Mitigations</h2>
<p>So this is all good and well, but how do we protect against such vulnerabilities?  The simple answer here is to stop using <code>eval</code>, <a href="http://postmodern.github.io/2013/03/07/its-simple-we-kill-eval.html" target="_blank">as described here</a>.  Essentially, Ruby blocks are so expressive and fast, that you shouldn&#39;t ever need to use <code>eval</code>.  While one may consider going to great lengths, jumping through hoops, hashing method names, and escaping method bodies, nothing is as simple or as effective as simply using blocks.  Lastly, note that <code>instance_eval</code> and <code>module_eval</code> will accept blocks, and you should <strong>always</strong> use blocks as opposed to string interpolation and <code>eval</code>.  If you haven&#39;t already gotten the hint, use blocks, blocks, and more blocks!</p>
<h2 id="some-example-code">Some Example Code</h2>
<pre><code class="lang-ruby"><span class="hljs-comment"># Here, Callbacks is a subclass of Hash</span>
<span class="hljs-comment"># The parser will create an instance of Callbacks with the fields below</span>
--- !ruby/<span class="hljs-symbol">hash:</span><span class="hljs-constant">Callbacks</span>
<span class="hljs-symbol">foo:</span> system <span class="hljs-string">'uname -a'</span>

<span class="hljs-comment"># If String#inspect is being used to escape a string, supply a</span>
<span class="hljs-comment"># struct instead of a string so that calling #inspect will just</span>
<span class="hljs-comment"># return what you want it to</span>
<span class="hljs-comment"># Ruby's duck-typing allows this to occur</span>
--- !ruby/struct
<span class="hljs-symbol">inspect:</span> system <span class="hljs-string">'uname -a'</span>
</code></pre>

                    
                    </section>
                
                </div>
            </div>
        </div>

        
        <a href="../index.html" class="navigation navigation-prev " aria-label="Previous page: Introduction"><i class="fa fa-angle-left"></i></a>
        
        
        <a href="../yaml/yaml1.html" class="navigation navigation-next " aria-label="Next page: YAML 1"><i class="fa fa-angle-right"></i></a>
        
    </div>
</div>

        
<script src="../gitbook/jsrepl/jsrepl.js" id="jsrepl-script"></script>
<script src="../gitbook/app.js"></script>

<script>
require(["gitbook"], function(gitbook) {
    var config = {"fontSettings":{"theme":"night"}};
    gitbook.start(config);
});
</script>

        
    </body>
    
</html>

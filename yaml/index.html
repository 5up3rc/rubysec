<!DOCTYPE HTML>
<html lang="en" >
    
    <head>
        
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <title>YAML | Ruby Security Field Guide</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 2.1.0">
        
        
        <meta name="HandheldFriendly" content="true"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
        <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">
        
    <link rel="stylesheet" href="../gitbook/style.css">
    
    

        
    
    
    <link rel="next" href="../yaml/yaml1.html" />
    
    
    <link rel="prev" href="../slides.html" />
    

        
    </head>
    <body>
        
        
    <div class="book" data-level="1" data-basepath=".." data-revision="Sun Jun 07 2015 16:48:27 GMT-0400 (EDT)">
    

<div class="book-summary">
    <div class="book-search">
        <input type="text" placeholder="Type to search" class="form-control" />
    </div>
    <ul class="summary">
        
        
        
        

        

        
    
        <li class="chapter " data-level="0" data-path="index.html">
            
                
                    <a href="../index.html">
                        <i class="fa fa-check"></i>
                        
                        Introduction
                    </a>
                
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="0.1" data-path="prerequisites.html">
            
                
                    <a href="../prerequisites.html">
                        <i class="fa fa-check"></i>
                        
                            <b>0.1.</b>
                        
                        Prerequisites
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="0.2" data-path="slides.html">
            
                
                    <a href="../slides.html">
                        <i class="fa fa-check"></i>
                        
                            <b>0.2.</b>
                        
                        Intro Slides
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter active" data-level="1" data-path="yaml/index.html">
            
                
                    <a href="../yaml/index.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.</b>
                        
                        YAML
                    </a>
                
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1" data-path="yaml/yaml1.html">
            
                
                    <a href="../yaml/yaml1.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.1.</b>
                        
                        YAML 1
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="yaml/yaml2.html">
            
                
                    <a href="../yaml/yaml2.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.2.</b>
                        
                        YAML 2
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="yaml/yaml3.html">
            
                
                    <a href="../yaml/yaml3.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.3.</b>
                        
                        YAML 3
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="yaml/yaml4.html">
            
                
                    <a href="../yaml/yaml4.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.4.</b>
                        
                        YAML 4
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2" data-path="parslet/index.html">
            
                
                    <a href="../parslet/index.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.</b>
                        
                        Parslet
                    </a>
                
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.1" data-path="parslet/json1.html">
            
                
                    <a href="../parslet/json1.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.1.</b>
                        
                        JSON 1
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="2.2" data-path="parslet/json2.html">
            
                
                    <a href="../parslet/json2.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.2.</b>
                        
                        JSON 2
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3" data-path="mutant/index.html">
            
                
                    <a href="../mutant/index.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.</b>
                        
                        Mutant
                    </a>
                
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1" data-path="mutant/mutant1.html">
            
                
                    <a href="../mutant/mutant1.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.1.</b>
                        
                        Mutant 1
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4" data-path="ronin/index.html">
            
                
                    <a href="../ronin/index.html">
                        <i class="fa fa-check"></i>
                        
                            <b>4.</b>
                        
                        Ronin
                    </a>
                
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1" data-path="ronin/exploit1.html">
            
                
                    <a href="../ronin/exploit1.html">
                        <i class="fa fa-check"></i>
                        
                            <b>4.1.</b>
                        
                        Exploit 1
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="5" data-path="resources.html">
            
                
                    <a href="../resources.html">
                        <i class="fa fa-check"></i>
                        
                            <b>5.</b>
                        
                        Resources
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="6" data-path="contributors.html">
            
                
                    <a href="../contributors.html">
                        <i class="fa fa-check"></i>
                        
                            <b>6.</b>
                        
                        Contributors
                    </a>
                
            
            
        </li>
    


        
        <li class="divider"></li>
        <li>
            <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
                Published with GitBook
            </a>
        </li>
        
    </ul>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="book-header">
    <!-- Actions Left -->
    <a href="#" class="btn pull-left toggle-summary" aria-label="Table of Contents"><i class="fa fa-align-justify"></i></a>
    <a href="#" class="btn pull-left toggle-search" aria-label="Search"><i class="fa fa-search"></i></a>
    
    <div id="font-settings-wrapper" class="dropdown pull-left">
        <a href="#" class="btn toggle-dropdown" aria-label="Font Settings"><i class="fa fa-font"></i>
        </a>
        <div class="dropdown-menu font-settings">
    <div class="dropdown-caret">
        <span class="caret-outer"></span>
        <span class="caret-inner"></span>
    </div>

    <div class="buttons">
        <button type="button" id="reduce-font-size" class="button size-2">A</button>
        <button type="button" id="enlarge-font-size" class="button size-2">A</button>
    </div>

    <div class="buttons font-family-list">
        <button type="button" data-font="0" class="button">Serif</button>
        <button type="button" data-font="1" class="button">Sans</button>
    </div>

    <div class="buttons color-theme-list">
        <button type="button" id="color-theme-preview-0" class="button size-3" data-theme="0">White</button>
        <button type="button" id="color-theme-preview-1" class="button size-3" data-theme="1">Sepia</button>
        <button type="button" id="color-theme-preview-2" class="button size-3" data-theme="2">Night</button>
    </div>
</div>

    </div>

    <!-- Actions Right -->
    
    <div class="dropdown pull-right">
        <a href="#" class="btn toggle-dropdown" aria-label="Share"><i class="fa fa-share-alt"></i>
        </a>
        <div class="dropdown-menu font-settings dropdown-left">
            <div class="dropdown-caret">
                <span class="caret-outer"></span>
                <span class="caret-inner"></span>
            </div>
            <div class="buttons">
                <button type="button" data-sharing="twitter" class="button">
                    Share on Twitter
                </button>
                <button type="button" data-sharing="google-plus" class="button">
                    Share on Google
                </button>
                <button type="button" data-sharing="facebook" class="button">
                    Share on Facebook
                </button>
                <button type="button" data-sharing="weibo" class="button">
                    Share on Weibo
                </button>
                <button type="button" data-sharing="instapaper" class="button">
                    Share on Instapaper
                </button>
            </div>
        </div>
    </div>
    

    
    <a href="#" target="_blank" class="btn pull-right google-plus-sharing-link sharing-link" data-sharing="google-plus" aria-label="Google"><i class="fa fa-google-plus"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right facebook-sharing-link sharing-link" data-sharing="facebook" aria-label="Facebook"><i class="fa fa-facebook"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right twitter-sharing-link sharing-link" data-sharing="twitter" aria-label="Twitter"><i class="fa fa-twitter"></i></a>
    
    
    


    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../" >Ruby Security Field Guide</a>
    </h1>
</div>

            <div class="page-wrapper" tabindex="-1">
                <div class="page-inner">
                
                
                    <section class="normal" id="section-">
                    
                        <h1 id="yaml">YAML</h1>
<p><a href="http://www.yaml.org" target="_blank">YAML</a>, the once de facto serialization format for Ruby on Rails, now disabled by default due to <a href="[https:/cve.mitre.org/cgi-bin/cvename.cgi">CVE-2013-0156</a>, is a superset of JSON.  YAML Supports all of the same regular types that JSON supports, however it also supports the serialization of arbitrary Ruby objects.  This can lead to vulnerabilities when combined with some common Ruby on Rails idions.</p>
<p>Most, if not all, YAML vulnerabiliies arise from the use of some form of Ruby&apos;s <code>eval</code> function. As Ruby&apos;s Class namespace is global, if there exists some class loaded at the time the YAML parser is running containing a call to eval then the YAML parser will be able to see and further access this <code>eval</code> usage. An attacker can then leverage this vulnerability to coerce the parser into making <code>eval</code> calls with arbitrary commands. If this sounds like a bad design to you it&apos;s because it is, and it&apos;s something that every Ruby programmer needs to be <em>very</em> aware of.</p>
<p>More specifically, to leverage this vulnerability, an attacker need only instantiate an instance of any class which directly <code>eval</code>s on input. A second methodology is to instantiate a class which <code>instance_eval</code>&apos;s input to dynamically define a method, which is a common idiom for Ruby on Rails, and then need only escape out of the method definition. It is further worth noting that if the dynamic method declaration takes the method name from the input then we can simply inject into the method name, as opposed to the body.</p>
<h2 id="pointers">Pointers</h2>
<ul>
<li><p>Find a class which uses some form of <code>eval</code> with one of it&apos;s fields. Note that you can set all of these fields in YAML, recall the global scope of Ruby classes, so you can pass input to the <code>eval</code> call.</p>
</li>
<li><p>Most of the time the <code>eval</code> call is used to dynamically define methods. While there are safer ways to do this, <code>eval</code> was used because it&apos;s supposedly faster in Ruby 1.8.  To do this you must craft the input to escape out of the method definition,run the desired code, and then start a new method definition so that the input parses correctly.</p>
</li>
<li><p>Sometimes it&apos;s possible to inject code inside the name of a method as opposed to it&apos;s body</p>
</li>
<li><p>If some form of string escaping technique is uesd, try crafting an instance of <code>Struct</code> which overrides whatever method name is performing the the escape.</p>
</li>
<li><p>Often times more complex forms of injection will be necessary.  Don&apos;t be afraid to get creative!</p>
</li>
</ul>
<h2 id="mitigations">Mitigations</h2>
<p>So this is all well and good, but how do we protect against such vulnerabilities?  The simple answer here is to stop using <code>eval</code>, <a href="http://postmodern.github.io/2013/03/07/its-simple-we-kill-eval.html" target="_blank">as described here</a>. Essentially, Ruby blocks are so expressive and fast, that you shouldn&apos;t ever need to use <code>eval</code>.  While one may consider going to great lengths, jumping through hoops, hashing method names, and escaping method bodies, nothing is as simple or as effective as simply using blocks. Lastly, note that <code>instance_eval</code> and <code>module_eval</code> will accept blocks, and you should <strong>always</strong> use blocks as opposed to string interpolation and <code>eval</code>. If you haven&apos;t already gotten the hint, use blocks, blocks, and more blocks!</p>
<h2 id="some-example-code">Some Example Code</h2>
<pre><code class="lang-ruby"><span class="hljs-comment"># Here, Callbacks is a subclass of Hash</span>
<span class="hljs-comment"># The parser will create an instance of Callbacks with the fields below</span>
--- !ruby/<span class="hljs-symbol">hash:</span><span class="hljs-constant">Callbacks</span>
<span class="hljs-symbol">foo:</span> system <span class="hljs-string">&apos;uname -a&apos;</span>

<span class="hljs-comment"># If String#inspect is being used to escape a string, supply a</span>
<span class="hljs-comment"># struct instead of a string so that calling #inspect will just</span>
<span class="hljs-comment"># return what you want it to</span>
<span class="hljs-comment"># Ruby&apos;s duck-typing allows this to occur</span>
--- !ruby/struct
<span class="hljs-symbol">inspect:</span> system <span class="hljs-string">&apos;uname -a&apos;</span>
</code></pre>

                    
                    </section>
                
                
                </div>
            </div>
        </div>

        
        <a href="../slides.html" class="navigation navigation-prev " aria-label="Previous page: Intro Slides"><i class="fa fa-angle-left"></i></a>
        
        
        <a href="../yaml/yaml1.html" class="navigation navigation-next " aria-label="Next page: YAML 1"><i class="fa fa-angle-right"></i></a>
        
    </div>
</div>

        
<script src="../gitbook/app.js"></script>

<script>
require(["gitbook"], function(gitbook) {
    var config = {"fontSettings":{"theme":null,"family":"sans","size":2}};
    gitbook.start(config);
});
</script>

        
    </body>
    
</html>
